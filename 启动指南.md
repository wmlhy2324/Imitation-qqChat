# Easy-Chat 项目启动指南

## 前置依赖

确保以下服务已启动：

- **MySQL**: `127.0.0.1:13306`
- **Redis**: `127.0.0.1:16379`
- **ETCD**: `127.0.0.1:3379`

## 快速启动（推荐）

### 使用启动脚本（一键启动所有服务）
```bash
# 启动所有服务
./start-local.sh

# 停止所有服务
./stop-local.sh

# 重启所有服务
./restart-local.sh
```

**启动脚本特性：**
- 自动检查依赖服务（MySQL、Redis、ETCD、MongoDB）
- 按正确顺序启动服务：User RPC → Social RPC → IM RPC → User API → Social API → IM API
- 实时显示启动状态和端口信息
- 自动生成日志文件到 `logs/` 目录
- 支持 Ctrl+C 优雅停止所有服务
- 彩色输出，状态清晰

## 手动启动顺序

### 1. User RPC 服务
```bash
cd apps/user/rpc
go run user.go
```

### 2. Social RPC 服务
```bash
cd apps/social/rpc
go run social.go
```

### 3. IM RPC 服务
```bash
cd apps/im/rpc
go run im.go
```

### 4. API 服务

#### User API 服务
```bash
cd apps/user/api
go run user.go
```

#### Social API 服务
```bash
cd apps/social/api
go run social.go
```

#### IM API 服务
```bash
cd apps/im/api
go run im.go
```

## 常见问题与解决方案

### 问题1: `panic: field "Name" is not set`

**原因**: ETCD 配置中心缺少对应的配置文件

**解决步骤**:

1. **检查 ETCD 中的配置**
```bash
etcdctl --endpoints=127.0.0.1:3379 get --prefix ""
```

2. **如果发现配置文件路径不匹配**
   
   例如：程序期望在 `/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/social/social-rpc.yaml`
   但实际在 `/conf/2-public/social/social-rpc.yaml`

3. **复制配置到正确路径**
```bash
# 复制 social RPC 配置
etcdctl --endpoints=127.0.0.1:3379 get "/conf/2-public/social/social-rpc.yaml" | tail -n +2 | etcdctl --endpoints=127.0.0.1:3379 put "/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/social/social-rpc.yaml"

# 复制 social API 配置
etcdctl --endpoints=127.0.0.1:3379 get "/conf/2-public/social/social-api.yaml" | tail -n +2 | etcdctl --endpoints=127.0.0.1:3379 put "/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/social/social-api.yaml"

# 复制 im 配置（如果需要）
etcdctl --endpoints=127.0.0.1:3379 get "/conf/2-public/im/im-rpc.yaml" | tail -n +2 | etcdctl --endpoints=127.0.0.1:3379 put "/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/im/im-rpc.yaml"

etcdctl --endpoints=127.0.0.1:3379 get "/conf/2-public/im/im-api.yaml" | tail -n +2 | etcdctl --endpoints=127.0.0.1:3379 put "/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/im/im-api.yaml"
```

4. **验证配置是否添加成功**
```bash
# 验证 social RPC 配置
etcdctl --endpoints=127.0.0.1:3379 get "/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/social/social-rpc.yaml"

# 验证 social API 配置
etcdctl --endpoints=127.0.0.1:3379 get "/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/social/social-api.yaml"
```

### 问题2: 连接数据库失败

**检查数据库连接配置**:
- MySQL 地址: `127.0.0.1:13306`
- 数据库名: `easy-chat`
- 用户名/密码: `root/easy-chat`

### 问题3: Redis 连接失败

**检查 Redis 配置**:
- Redis 地址: `127.0.0.1:16379`
- 密码: `easy-chat`

## 配置文件说明

### 本地配置文件位置
- User: `apps/user/rpc/etc/dev/user.yaml`
- Social: `apps/social/rpc/etc/dev/social.yaml`
- IM: `apps/im/rpc/etc/dev/im.yaml`

### 远程配置文件位置（ETCD）
**RPC 服务配置：**
- User RPC: `/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/user/user-rpc.yaml`
- Social RPC: `/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/social/social-rpc.yaml`
- IM RPC: `/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/im/im-rpc.yaml`

**API 服务配置：**
- User API: `/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/user/user-api.yaml`
- Social API: `/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/social/social-api.yaml`
- IM API: `/conf/98c6f2c2287f4c73cea3d40ae7ec3ff2/im/im-api.yaml`

### 配置下载位置
启动时，远程配置会自动下载到：
**RPC 服务：**
- `apps/user/rpc/etc/conf/user-rpc.yaml`
- `apps/social/rpc/etc/conf/social-rpc.yaml`
- `apps/im/rpc/etc/conf/im-rpc.yaml`

**API 服务：**
- `apps/user/api/etc/conf/user-api.yaml`
- `apps/social/api/etc/conf/social-api.yaml`
- `apps/im/api/etc/conf/im-api.yaml`

## 项目架构

```
easy-chat/
├── apps/
│   ├── user/           # 用户服务
│   │   ├── api/        # 用户 HTTP API
│   │   ├── rpc/        # 用户 gRPC 服务
│   │   └── models/     # 用户数据模型
│   ├── social/         # 社交服务（好友、群组）
│   │   ├── api/        # 社交 HTTP API
│   │   └── rpc/        # 社交 gRPC 服务
│   └── im/             # 即时通讯服务
│       ├── api/        # IM HTTP API
│       ├── rpc/        # IM gRPC 服务
│       └── ws/         # WebSocket 服务
├── pkg/                # 公共组件
└── deploy/             # 部署配置
```

## 端口分配

| 服务 | 端口 | 说明 |
|------|------|------|
| User RPC | 10000 | 用户 gRPC 服务 |
| Social RPC | 10001 | 社交 gRPC 服务 |
| IM RPC | 10002 | IM gRPC 服务 |
| User API | 8888 | 用户 HTTP API |
| Social API | 8881 | 社交 HTTP API |
| IM API | 8882 | IM HTTP API |

## 测试验证

服务启动成功后，可以访问：
- User API: `http://localhost:8888`
- Social API: `http://localhost:8881`
- IM API: `http://localhost:8882`

## 启动脚本详细说明

### 脚本文件
- `start-local.sh` - 启动所有服务
- `stop-local.sh` - 停止所有服务  
- `restart-local.sh` - 重启所有服务

### 使用方法
```bash
# 给脚本添加执行权限（首次使用）
chmod +x *.sh

# 启动所有服务
./start-local.sh

# 在另一个终端停止服务
./stop-local.sh

# 重启服务
./restart-local.sh
```

### 日志查看
启动脚本会在 `logs/` 目录下生成各服务的日志文件：
```bash
# 查看实时日志
tail -f logs/user-rpc.log
tail -f logs/social-api.log

# 查看所有日志文件
ls -la logs/
```

### 故障排除
1. **端口被占用**：脚本会自动检查端口占用情况
2. **依赖服务未启动**：脚本会检查 MySQL、Redis、ETCD 等依赖
3. **启动失败**：查看对应的日志文件排查问题
4. **强制清理**：`./stop-local.sh` 会强制杀死相关进程

---

**注意**: 
- 推荐使用启动脚本，可避免手动启动时的依赖顺序问题
- 脚本支持优雅停止，按 Ctrl+C 即可停止所有服务
- MongoDB 是可选依赖，仅 IM 服务需要
